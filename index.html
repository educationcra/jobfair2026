<!DOCTYPE html>
<html lang="th">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRA Roadshow 2026 - Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100;300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script>
    tailwind.config = {
      theme: { 
        extend: { 
          fontFamily: { sans: ['"Noto Sans Thai"', 'sans-serif'] },
          colors: { cra: { primary: '#0F2C67', secondary: '#E65100' } }
        }
      }
    }
  </script>
  <style>
    * { font-family: 'Noto Sans Thai', sans-serif !important; }
    @media print {
      .no-print { display: none !important; }
      .chart-container { display: none !important; }
      .table-container { display: block !important; }
      .print-only { display: block !important; }
      body { background-color: white; padding: 0; }
      .container { max-width: 100%; width: 100%; }
      .card { box-shadow: none !important; border: 1px solid #eee !important; break-inside: avoid; margin-bottom: 20px; }
    }
    .print-only { display: none; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0F2C67; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .btn-school-item { transition: all 0.2s; min-height: 54px; }

    /* --- ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏¢‡∏Å --- */
    @media only screen and (max-width: 768px), print {
      #source-split-grid { gap: 0 !important; }
      #source-split-grid > div:nth-child(2) > div:first-child { display: none !important; } /* ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡πâ‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2 */
      #source-split-grid > div:nth-child(1) > div:last-child { border-bottom: none !important; } /* ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏Ñ‡∏±‡πà‡∏ô‡∏£‡∏≠‡∏¢‡∏ï‡πà‡∏≠ */
      #source-split-grid > div:nth-child(2) > div:nth-child(2) { border-top: none !important; margin-top: -1px; }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased">

  <div id="loading" class="fixed inset-0 bg-white/95 z-[60] flex flex-col items-center justify-center">
    <div class="loader mb-4"></div>
    <p class="text-cra-primary font-bold animate-pulse text-lg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á...</p>
    <p class="text-sm text-gray-400 mt-2">Connecting to CRA Database...</p>
  </div>

  <div id="mainApp" class="container mx-auto px-4 py-8 max-w-7xl opacity-0 transition-opacity duration-700">
    <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 border-b border-gray-200 pb-6 no-print">
      <div class="flex items-center gap-3">
        <svg class="w-10 h-10 text-cra-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
        <h1 class="text-3xl font-bold text-cra-primary">CRA Roadshow 2026</h1>
      </div>
      <div class="flex gap-2">
        <button onclick="openSchoolModal()" class="flex items-center gap-2 px-4 py-3 bg-white border-2 border-cra-primary text-cra-primary rounded-xl font-bold hover:bg-blue-50 transition shadow-sm">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
          ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <span id="schoolCountBadge" class="bg-cra-primary text-white text-xs px-2 py-0.5 rounded-full ml-1 font-sans">All</span>
        </button>
        <button onclick="window.print()" class="flex items-center gap-2 px-4 py-3 bg-cra-primary text-white rounded-xl font-bold hover:bg-blue-900 transition shadow-md">
          ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°
        </button>
      </div>
    </header>

    <div id="dynamicSchoolTitle" class="mb-4 text-2xl font-bold text-slate-700 px-2 flex items-center flex-wrap gap-2"></div>

    <div class="mb-6 bg-gradient-to-r from-blue-900 to-cra-primary rounded-2xl p-6 text-white flex items-center justify-between card shadow-lg">
       <h2 class="text-xl font-semibold opacity-90 flex items-center gap-3">
         <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 005.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
         ‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
       </h2>
       <div class="text-right"><span class="text-5xl font-bold" id="kpiTotal">0</span><span class="text-xl ml-2 opacity-80">‡∏Ñ‡∏ô</span></div>
    </div>

    <div id="schoolSectionTop" class="mb-8 hidden">
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 card">
        <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg">
          <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg> 
          ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </h3>
        <div id="schoolTableContainer"></div>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8 mb-8 card">
      <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
        <svg class="w-7 h-7 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
        ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à
      </h3>
      <div id="satisfactionContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </div>

    <div id="pieCardContainer" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8"></div>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-8 card">
      <h3 class="text-xl font-bold text-cra-primary mb-4 flex items-center gap-2 text-slate-700">
        <svg class="w-7 h-7 text-cra-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg> 
        ‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°
      </h3>
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-left border-collapse">
          <thead class="bg-gray-50 text-gray-600 font-bold uppercase"><tr><th class="p-3 w-16 text-center">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th class="p-3">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</th><th class="p-3 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="p-3 text-right">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞</th><th class="p-3 w-1/4 no-print">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡∏¢‡∏°</th></tr></thead>
          <tbody id="currTableBody" class="divide-y"></tbody>
        </table>
      </div>
    </div>

    <div id="dynamicGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8"></div>

    <div class="bg-white rounded-2xl border p-6 mb-8 card">
      <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg text-slate-700">
        <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg> 
        ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏£‡∏≤‡∏ä‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏à‡∏∏‡∏¨‡∏≤‡∏†‡∏£‡∏ì‡πå‡∏ú‡πà‡∏≤‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÉ‡∏î
      </h3>
      <div id="sourceTableContainer"></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 no-print mb-8">
      <button onclick="openCustomModal('newCurr')" class="bg-blue-50 p-6 rounded-2xl border-2 border-blue-100 flex flex-col items-center hover:bg-blue-100 transition group shadow-sm">
        <h3 class="font-bold text-cra-primary text-xl mb-3 flex items-center gap-2">
          <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.168.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
          ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î
        </h3>
        <span class="bg-white px-8 py-2 rounded-full shadow font-bold text-cra-primary group-hover:scale-105 transition">‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</span>
      </button>
      <button onclick="openCustomModal('suggest')" class="bg-orange-50 p-6 rounded-2xl border-2 border-orange-100 flex flex-col items-center hover:bg-orange-100 transition group shadow-sm">
        <h3 class="font-bold text-cra-secondary text-xl mb-3 flex items-center gap-2 text-cra-secondary">
          <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
          ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
        </h3>
        <span class="bg-white px-8 py-2 rounded-full shadow font-bold text-cra-secondary group-hover:scale-105 transition">‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</span>
      </button>
    </div>

    <div class="print-only">
      <div class="card p-6 mb-8"><h3 class="text-xl font-bold mb-4 text-cra-primary">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h3><div id="printNewCurrContainer"></div></div>
      <div class="card p-6"><h3 class="text-xl font-bold mb-4 text-cra-secondary">‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h3><div id="printSuggestContainer"></div></div>
    </div>
  </div>

  <div id="modalBase" class="fixed inset-0 z-50 hidden no-print">
    <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm" onclick="closeModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col relative overflow-hidden">
        <div class="p-6 border-b border-gray-100 bg-gray-50 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
          <div id="mHeader" class="text-xl font-bold text-cra-primary flex items-center gap-2"></div>
          <div class="flex items-center gap-3">
            <div id="modalActions" class="flex gap-2"></div>
            <button onclick="closeModal()" class="bg-white text-gray-400 hover:text-red-500 rounded-full p-2 border transition">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
        </div>
        <div id="mBody" class="p-6 overflow-y-auto bg-white"></div>
      </div>
    </div>
  </div>

  <script>
    // ******************************************************
    // ‡∏ß‡∏≤‡∏á URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy Google Apps Script ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    // ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec
    // ******************************************************
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwI9vJzgBJ4x99aQ-fTxJXIyDGbKUsRVMELrZ1yTc5dHJ0gu4mWMoYuPU9QVPCcVTNkTQ/exec'; 
    // ******************************************************

    Chart.register(ChartDataLabels);
    const ICONS = {
      table: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>`,
      chart: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/></svg>`,
      medal: (c) => `<svg class="w-8 h-8 mx-auto" viewBox="0 0 24 24" fill="${c}"><path d="M12 2l2.4 7.4h7.6l-6.2 4.5 2.4 7.4-6.2-4.5-6.2 4.5 2.4-7.4-6.2-4.5h7.6z"/></svg>`,
      school: `<svg class="w-7 h-7 text-cra-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>`,
      academic: `<svg class="w-5 h-5 text-cra-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 14l9-5-9-5-9 5 9 5z M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/></svg>`,
      calendar: `<svg class="w-5 h-5 text-cra-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>`,
      media: `<svg class="w-5 h-5 text-cra-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>`,
      platform: `<svg class="w-5 h-5 text-cra-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>`
    };

    let RAW_DATA = [], selectedSchools = [], allSchools = [];

    window.onload = async () => {
      try {
        if(GAS_API_URL.includes("‡πÑ‡∏≠‡∏î‡∏µ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì")) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 262 ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
          return;
        }

        const response = await fetch(GAS_API_URL);
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        
        RAW_DATA = data;
        allSchools = [...new Set(data.map(r => r[1].trim()))].sort();
        selectedSchools = [...allSchools];
        renderDashboard();
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('opacity-0');
        
      } catch (error) {
        console.error('Error fetching data:', error);
        document.getElementById('loading').innerHTML = `
          <div class="text-red-500 font-bold text-center p-4">
            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ <br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Permission (Anyone)<br>
            <span class="text-xs text-gray-400 font-normal">${error.message}</span>
          </div>
        `;
      }
    };

    function preciseRound(number, decimals = 1) {
      const multiplier = Math.pow(10, decimals);
      const n = number * multiplier;
      const rounded = Math.round(n);
      const diff = n - Math.floor(n);
      if (Math.abs(diff - 0.5) < Number.EPSILON) {
        return (Math.floor(n) % 2 === 0 ? Math.floor(n) : Math.ceil(n)) / multiplier;
      }
      return rounded / multiplier;
    }

    function renderDashboard() {
      const data = RAW_DATA.filter(r => selectedSchools.includes(r[1].trim()));
      const total = data.length;
      
      const titleDiv = document.getElementById('dynamicSchoolTitle');
      if(selectedSchools.length === 1) {
        titleDiv.innerHTML = `${ICONS.school} <span>${selectedSchools[0]}</span>`;
        document.getElementById('schoolSectionTop').classList.add('hidden');
      } else {
        const baseT = selectedSchools.length === allSchools.length ? "‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" : "‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•";
        titleDiv.innerHTML = `${ICONS.school} <span>${baseT}</span> <span class="bg-gray-200 px-3 py-1 rounded-lg text-slate-600 font-bold border border-gray-300 ml-1 font-sans">${selectedSchools.length} ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>`;
        document.getElementById('schoolSectionTop').classList.remove('hidden');
      }

      document.getElementById('kpiTotal').innerText = total.toLocaleString();
      document.getElementById('schoolCountBadge').innerText = selectedSchools.length === allSchools.length ? 'All' : selectedSchools.length;
      
      renderSatisfaction(data);
      renderPieSections(data, total);
      renderRankingTable('currTableBody', getCounts(data, 7), total, true);
      renderSimpleTable('schoolTableContainer', getCounts(data, 1), total, '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');

      const dynGrid = document.getElementById('dynamicGrid'); dynGrid.innerHTML = '';
      const configs = [
        { id: 'edu', col: 3, title: '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤', icon: ICONS.academic },
        { id: 'round', col: 8, title: '‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à', icon: ICONS.calendar },
        { id: 'media', col: 6, title: '‡∏™‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', multi: true, icon: ICONS.media },
        { id: 'plat', col: 14, title: '‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ', multi: true, icon: ICONS.platform }
      ];
      configs.forEach(c => {
        const div = document.createElement('div'); div.className = "bg-white rounded-2xl border p-6 card flex flex-col";
        div.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="font-bold text-sm flex items-center gap-2 text-slate-700">${c.icon} ${c.title}</h3><div class="flex bg-gray-100 rounded-lg p-1 no-print"><button onclick="toggleV('${c.id}','table')" id="btn${c.id}Table" class="p-1.5 rounded bg-white shadow text-cra-primary transition">${ICONS.table}</button><button onclick="toggleV('${c.id}','chart')" id="btn${c.id}Chart" class="p-1.5 rounded text-gray-400 ml-1 transition">${ICONS.chart}</button></div></div><div id="v${c.id}Chart" class="h-48 chart-container hidden"><canvas id="c${c.id}"></canvas></div><div id="v${c.id}Table" class="table-container">${renderTableHTML(getCounts(data, c.col, c.multi), total, c.title)}</div>`;
        dynGrid.appendChild(div); renderChart(`c${c.id}`, 'bar', getCounts(data, c.col, c.multi), total);
      });
      renderSplitTable('sourceTableContainer', getCounts(data, 5, true), total);
      renderPrintData(data);
    }

    function renderSatisfaction(data) {
      const m = [
        {c:9, l:'‡∏™‡∏ô‡πÉ‡∏à‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏ä‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏à‡∏∏‡∏¨‡∏≤‡∏†‡∏£‡∏ì‡πå', ic:'M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z'}, 
        {c:10, l:'‡∏™‡∏∑‡πà‡∏≠‡πÅ‡∏ô‡∏∞‡πÅ‡∏ô‡∏ß‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', ic:'M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z'}, 
        {c:11, l:'‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', ic:'M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'}, 
        {c:15, l:'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏à Education CRA', ic:'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z'}
      ];
      document.getElementById('satisfactionContainer').innerHTML = m.map(item => {
        let sum = 0, validC = 0;
        data.forEach(r => { let v = r[item.c]; if(v){ let n = parseFloat(v); if(!isNaN(n)){ sum += n; validC++; } } });
        let avg = validC ? preciseRound(sum/validC, 2).toFixed(2) : "0.00";
        let pct = preciseRound((parseFloat(avg)/5)*100, 1).toFixed(1);
        return `<div class="bg-slate-50 p-4 rounded-xl border flex flex-col shadow-sm"><div class="flex justify-between items-center mb-3"><span class="text-sm font-medium text-slate-700 flex items-center gap-2"><svg class="w-5 h-5 text-cra-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${item.ic}"/></svg>${item.l}</span><div class="flex items-center gap-2 font-bold text-slate-900">${avg}/5 <span class="bg-cra-primary text-white text-[10px] px-2 py-0.5 rounded shadow-sm">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ ${pct}</span></div></div><div class="w-full bg-gray-200 h-2 rounded-full overflow-hidden"><div class="bg-cra-primary h-full transition-all duration-1000" style="width:${pct}%"></div></div></div>`;
      }).join('');
    }

    function renderRankingTable(containerId, data, total, showBar = false) {
      document.getElementById(containerId).innerHTML = data.map((it, i) => {
        let p = preciseRound(it[1]*100/total, 1).toFixed(1), icon = i < 3 ? ICONS.medal(['#fbbf24','#94a3b8','#d97706'][i]) : i+1;
        let rs = i===0 ? "bg-yellow-50" : i===1 ? "bg-slate-100" : i===2 ? "bg-orange-50" : "";
        return `<tr class="${rs} hover:opacity-90"> <td class="p-4 text-center font-bold">${icon}</td> <td class="p-4 font-medium text-slate-700">${it[0]}</td> <td class="p-4 text-right font-bold text-cra-primary">${it[1]}</td> <td class="p-4 text-right text-gray-500 font-semibold">${p}</td> ${showBar ? `<td class="p-4 no-print"><div class="w-full bg-gray-200 h-1.5 rounded-full overflow-hidden"><div class="bg-cra-primary h-1.5 rounded-full" style="width:${p}%"></div></div></td>` : ''}</tr>`;
      }).join('');
    }

    function openSchoolModal() {
      document.getElementById('mHeader').innerHTML = `<span class="flex items-center gap-2">${ICONS.school} ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>`;
      document.getElementById('modalActions').innerHTML = `
        <button onclick="selectAll(true)" class="text-xs bg-cra-primary text-white px-3 py-2 rounded-lg hover:bg-blue-900 transition font-bold shadow-sm flex items-center gap-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button onclick="selectAll(false)" class="text-xs bg-slate-200 text-slate-600 px-3 py-2 rounded-lg hover:bg-slate-300 transition font-bold shadow-sm flex items-center gap-1">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      `;
      renderSchoolList();
      document.getElementById('modalBase').classList.remove('hidden');
    }

    function renderSchoolList() {
      document.getElementById('mBody').innerHTML = `
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mb-6" id="schoolGrid">
          ${allSchools.map(s => {
            const isS = selectedSchools.includes(s);
            return `<button onclick="toggleS('${s}')" class="btn-school-item p-4 text-left border rounded-xl text-sm ${isS?'bg-blue-50 border-cra-primary text-cra-primary font-bold shadow-sm':'bg-white border-gray-200 text-slate-500'}">
              <span class="flex items-center gap-2">${isS?'‚úì':''} ${s}</span>
            </button>`;
          }).join('')}
        </div>
        <div class="sticky bottom-0 bg-white py-4 border-t border-gray-100 flex justify-center">
          <button onclick="closeModal();renderDashboard();" class="w-full max-w-md py-4 bg-green-600 text-white font-bold text-lg rounded-xl shadow-lg hover:bg-green-700 transition transform active:scale-95">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</button>
        </div>`;
    }

    function selectAll(v) { selectedSchools = v ? [...allSchools] : []; renderSchoolList(); }
    function toggleS(s) { if(selectedSchools.includes(s)) selectedSchools = selectedSchools.filter(x=>x!==s); else selectedSchools.push(s); renderSchoolList(); }
    function closeModal() { document.getElementById('modalBase').classList.add('hidden'); }

    function openCustomModal(type) {
      document.getElementById('modalActions').innerHTML = '';
      const data = RAW_DATA.filter(r => selectedSchools.includes(r[1].trim()));
      const h = type === 'newCurr' ? '‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°' : '‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°';
      const icon = type === 'newCurr' ? 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.168.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253' : 'M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z';
      document.getElementById('mHeader').innerHTML = `<span class="flex items-center gap-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${icon}"/></svg>${h}</span>`;
      
      if(type === 'newCurr') {
        const list = getCounts(data, 16, true);
        document.getElementById('mBody').innerHTML = `<table class="w-full text-sm border-collapse"><thead class="bg-gray-100 uppercase font-bold text-slate-600"><tr><th class="p-3 w-16 text-center border-b">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th class="p-3 border-b">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</th><th class="p-3 text-right border-b">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="p-3 text-right border-b">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞</th></tr></thead><tbody id="modalRankBody" class="divide-y"></tbody></table>`;
        renderRankingTable('modalRankBody', list, data.length, false);
      } else {
        const list = [...new Set(data.map(r => r[12]))].filter(v => v && v.toString().length > 2);
        document.getElementById('mBody').innerHTML = `<ul class="space-y-3">${list.map(v => `<li class="p-4 bg-slate-50 rounded-xl border border-gray-100 flex gap-3 text-sm text-slate-700 font-medium group hover:bg-white transition shadow-sm"><span class="text-orange-400">üí¨</span> ${v}</li>`).join('')}</ul>`;
      }
      document.getElementById('modalBase').classList.remove('hidden');
    }

    function renderPieSections(data, total) {
      const container = document.getElementById('pieCardContainer'); container.innerHTML = '';
      const items = [
        { id: 'G', col: 2, title: '‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏®', ic: 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' }, 
        { id: 'K', col: 4, title: '‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏£‡∏≤‡∏ä‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏à‡∏∏‡∏¨‡∏≤‡∏†‡∏£‡∏ì‡πå', ic: 'M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z' }, 
        { id: 'F', col: 13, title: '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏à Education CRA', ic: 'M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1' }
      ];
      items.forEach(p => {
        const div = document.createElement('div'); div.className = "bg-white rounded-2xl border p-6 card flex flex-col";
        div.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="font-bold text-sm flex items-center gap-2 text-slate-700"><svg class="w-5 h-5 text-cra-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${p.ic}"/></svg>${p.title}</h3><div class="flex bg-gray-100 rounded-lg p-1 no-print"><button onclick="toggleV('${p.id}','table')" id="btn${p.id}Table" class="p-1.5 rounded bg-white shadow text-cra-primary transition">${ICONS.table}</button><button onclick="toggleV('${p.id}','chart')" id="btn${p.id}Chart" class="p-1.5 rounded text-gray-400 ml-1 transition">${ICONS.chart}</button></div></div><div id="v${p.id}Chart" class="h-48 chart-container hidden"><canvas id="c${p.id}"></canvas></div><div id="v${p.id}Table" class="table-container">${renderTableHTML(getCounts(data, p.col), total, p.title)}</div>`;
        container.appendChild(div); renderChart(`c${p.id}`, 'pie', getCounts(data, p.col), total);
      });
    }

    function renderTableHTML(data, total, header) { return `<table class="w-full text-sm"><thead class="bg-gray-50 font-bold uppercase text-gray-600"><tr><th class="p-2 text-left">${header}</th><th class="p-2 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="p-2 text-right">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞</th></tr></thead><tbody>${data.map(i => `<tr class="border-b"><td class="p-2 text-slate-700 font-medium">${i[0]}</td><td class="p-2 text-right font-bold text-cra-primary">${i[1]}</td><td class="p-2 text-right font-semibold text-gray-500">${preciseRound(i[1]*100/total, 1).toFixed(1)}</td></tr>`).join('')}</tbody></table>`; }
    function renderSimpleTable(id, data, total, header) { document.getElementById(id).innerHTML = `<table class="w-full text-sm border"><thead class="bg-gray-100 font-bold uppercase text-gray-600"><tr><th class="p-2 text-left border-b">${header}</th><th class="p-2 text-right border-b">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="p-2 text-right border-b">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞</th></tr></thead><tbody>${data.map(i => `<tr class="border-b hover:bg-slate-50 transition"><td class="p-2 text-slate-700 font-medium">${i[0]}</td><td class="p-2 text-right font-bold text-cra-primary">${i[1]}</td><td class="p-2 text-right font-semibold text-gray-500">${preciseRound(i[1]*100/total, 1).toFixed(1)}</td></tr>`).join('')}</tbody></table>`; }
    
    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ‡πÄ‡∏û‡∏¥‡πà‡∏° id="source-split-grid" ‡πÉ‡∏´‡πâ div
    function renderSplitTable(id, data, total) { const mid = Math.ceil(data.length/2), L=data.slice(0,mid), R=data.slice(mid), head=`<div class="flex justify-between bg-gray-100 p-2 font-bold-[11px] uppercase text-gray-600 border-b font-sans"><span>‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏ú‡πà‡∏≤‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</span><div class="flex gap-4"><span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</span><span>‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞</span></div></div>`, row=(d)=>`<div class="flex justify-between py-1.5 border-b text-[12px] px-1 hover:bg-slate-50 font-sans"><span>${d[0]}</span><div class="flex gap-4 font-bold text-cra-primary"><span>${d[1]}</span><span class="text-gray-400 font-normal w-12 text-right">${preciseRound(d[1]*100/total, 1).toFixed(1)}</span></div></div>`; document.getElementById(id).innerHTML=`<div id="source-split-grid" class="grid grid-cols-1 md:grid-cols-2 gap-x-12"><div>${head}${L.map(row).join('')}</div><div>${head}${R.map(row).join('')}</div></div>`; }
    
    function toggleV(id, m) { const isT=m==='table'; document.getElementById(`v${id}Table`).classList.toggle('hidden',!isT); document.getElementById(`v${id}Chart`).classList.toggle('hidden',isT); document.getElementById(`btn${id}Table`).className=isT?"p-1.5 rounded bg-white shadow text-cra-primary":"p-1.5 rounded text-gray-400 ml-1"; document.getElementById(`btn${id}Chart`).className=!isT?"p-1.5 rounded bg-white shadow text-cra-primary":"p-1.5 rounded text-gray-400 ml-1"; }
    function getCounts(data, idx, multi) { let c={}; data.forEach(r => { let v=multi?r[idx].toString().split(/,\s*/):[r[idx].toString().trim()]; v.forEach(x=>{if(x)c[x]=(c[x]||0)+1;}); }); return Object.entries(c).sort((a,b)=>b[1]-a[1]); }
    function renderChart(id, type, data, total) { new Chart(document.getElementById(id),{type:type,data:{labels:data.map(d=>d[0]),datasets:[{data:data.map(d=>d[1]),backgroundColor:['#0F2C67','#E65100','#3b82f6','#10b981','#f59e0b']}]},options:{maintainAspectRatio:false,plugins:{datalabels:{color:'#fff',font:{family:'"Noto Sans Thai"'},formatter:(v)=>`${v}\n(${preciseRound(v*100/total, 0).toFixed(0)}%)`},legend:{position:'right',labels:{font:{family:'"Noto Sans Thai"',size:9},boxWidth:10}}}}}); }
    function renderPrintData(data) {
      const nl = getCounts(data, 16, true);
      document.getElementById('printNewCurrContainer').innerHTML = `<table class="w-full text-sm border font-sans"><thead><tr class="bg-gray-100 font-bold uppercase text-slate-600"><th class="p-2 border-b">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th class="p-2 border-b">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</th><th class="p-2 border-b text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="p-2 border-b text-right">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞</th></tr></thead><tbody>${nl.map((it, i) => `<tr><td class="text-center p-2 border-b">${i+1}</td><td class="p-2 border-b">${it[0]}</td><td class="text-right font-bold p-2 border-b">${it[1]}</td><td class="text-right p-2 border-b">${preciseRound(it[1]*100/data.length, 1).toFixed(1)}</td></tr>`).join('')}</tbody></table>`;
      const sg = [...new Set(data.map(r => r[12]))].filter(v => v && v.toString().length > 2);
      document.getElementById('printSuggestContainer').innerHTML = sg.length ? `<ul class="list-disc pl-8 space-y-1 text-sm">${sg.map(v => `<li class="text-slate-700">${v}</li>`).join('')}</ul>` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    }
  </script>
</body>
</html>
